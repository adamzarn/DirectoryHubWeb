<!doctype html>
<html>

	<head>
		<title>Directory</title>
		<link href="styles/main.css" rel="stylesheet" />

		<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">

		<!-- Optional theme -->
		<!--<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap-theme.min.css" integrity="sha384-rHyoN1iRsVXV4nD0JutlnGaslCJuC7uwjduW9SVrLvRYooPp2bWYgmgJQIXwl/Sp" crossorigin="anonymous">-->

	</head>

	<body>

		<header>
    		<h1>Find Your Church</h1>
  		</header>

  		<table id="churchesTable">
			<tbody>
				<th>Church</th>
				<th>City</th>
			</tbody>
		</table>

		<div id="myModal" class="modal">
  			<div class="modal-content">
    			<span class="close">&times;</span>
    			<p id="passwordPrompt"></p>
    			<input id="passwordField" type="password" name="password"><br>
  				<input id="submitButton" type="submit" value="Submit">
  			</div>
		</div>
	
	</body>

 	<script src="https://www.gstatic.com/firebasejs/4.1.3/firebase.js"></script>
	
	<script>
  	// Initialize Firebase
  	var config = {
    	apiKey: "AIzaSyDS6zch98V15uvpqsbKqnRrMnv3Ha_vMcA",
    	authDomain: "valleybrookcommunitychur-77604.firebaseapp.com",
    	databaseURL: "https://valleybrookcommunitychur-77604.firebaseio.com",
    	projectId: "valleybrookcommunitychur-77604",
    	storageBucket: "valleybrookcommunitychur-77604.appspot.com",
    	messagingSenderId: "301967649981"
  	};
  	firebase.initializeApp(config);

  	var title = document.getElementById('title');

	var ref = firebase.database().ref("Churches").orderByKey();

	ref.once("value")
  		.then(function(snapshot) {
  			var churches = [];
  			snapshot.forEach(function(childSnapshot) {

  				var church = {
  					name: childSnapshot.key,
  					loc: childSnapshot.child('location').val(),
  					password: childSnapshot.child('password').val(),
  					adminPassword: childSnapshot.child('adminPassword').val()
  				};

  				addRow(church.name, church.loc);
  				churches.push(church);
    		})

			localStorage.setItem("churches", JSON.stringify(churches));

  			addRowHandlers();

    	});

    function addRow(name, location) {

         if (!document.getElementsByTagName) return;

         tabBody=document.getElementsByTagName("tbody").item(0);

         row=document.createElement("tr");
         nameCell = document.createElement("td");
         locationCell = document.createElement("td");

         nameNode=document.createTextNode(name);
         locationNode=document.createTextNode(location);

         nameCell.appendChild(nameNode);
         locationCell.appendChild(locationNode);

         row.appendChild(nameCell);
         row.appendChild(locationCell);

         tabBody.appendChild(row);
	}

	function addRowHandlers() {
    var table = document.getElementById("churchesTable");
    var rows = table.getElementsByTagName("tr");
    for (i = 0; i < rows.length; i++) {
        var currentRow = table.rows[i];
        var createClickHandler = function(row) {
        	return function() {

                var cell = row.getElementsByTagName("td")[0];
                var position = row.rowIndex;
                var name = cell.innerHTML;
                var modal = document.getElementById('myModal');
				var span = document.getElementsByClassName("close")[0];
				var passwordField = document.getElementById('passwordField');
				var submitButton = document.getElementById('submitButton');
				var passwordPrompt = document.getElementById('passwordPrompt');
				passwordPrompt.innerHTML = "To access the directory, enter the password for " + name + ":";
                modal.style.display = "block";

				span.onclick = function() {
    				modal.style.display = "none";
    				var passwordField = document.getElementById('passwordField');
        			passwordField.value = "";
				}

				window.onclick = function(event) {
    				if (event.target == modal) {
        				modal.style.display = "none";
        				var passwordField = document.getElementById('passwordField');
        				passwordField.value = "";
    				}
				}

				submitButton.onclick = function() {
					var storedChurches = JSON.parse(localStorage.getItem("churches"));
					var church = storedChurches[position-1];
					var passwordField = document.getElementById('passwordField');
					if (church.password == passwordField.value) {
						console.log('Correct Password');
					} else {
						console.log('Incorrect Password');
					}
				}

            };
        };
        currentRow.onclick = createClickHandler(currentRow);
    }

}

	</script>

</html>